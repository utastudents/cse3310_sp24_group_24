<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="./css/lobby_styles.css">
<title>WordSearch</title>
<style>
    table {
        border-collapse: collapse;
    }
    td {
        border: 1px solid black;
        width: 20px;
        height: 20px;
        text-align: center;
        font-size: 15px;
        background-color: cadetblue;
        
    }
    
    .scroll-box{
        width: 300px;
        height: 150px;
        overflow: auto;
        border: 1px solid black;
        padding: 10px;
    }
    #leftbox{
        float: left;
        background-color: lightblue;
        height: 80%;
    }
    #centerbox{
        float: left;
    }
    #rightbox{
        float: right;
        background-color: lightblue;
        height: 80%;
    }
    .crossed-out {
        text-decoration: line-through;
    }
    .selected {
        background-color: red;
    }
</style>
</head>
    <body>
        <div id="boxes">
            <h1 style="text-align: center;"> WORD SEARCH GAME </h1>

            <div id="leftbox">
                <h2> Player 1 Name </h2>
            </div>

            <div id="centerbox">
                <div id="table-container"> 
                    
                </div>
                <h2 style="text-align: center;"> WORD BANK </h2>
                <div class="scroll-box" id="answer-container"> 

                </div>
            </div>
    
            <div id="rightbox">
                <h2> Player 2 Name</h2>
            </div>
       
        </div>
    </body>
</html>

<script>
    var connection = null;

    var serverUrl;
    serverUrl = "ws://" + window.location.hostname + ":9880";
    // Create the connection with the server
    connection = new WebSocket(serverUrl);

    connection.onopen = function (evt) 
    { 
        console.log("open");
        connection.send("PlayerInfo," + localStorage.getItem('playerName') + "," + localStorage.getItem('playerColor') + ",");
        
        
    }

    connection.onclose = function (evt) 
    {
        console.log("close");
    }
    
    connection.onmessage = function (evt) {
        var msg;
        msg = JSON.parse(evt.data);
        console.log("Message received: " + msg);

        switch(msg.type){
            case 'Grid':
                console.log("Grid recieved");
                displayWordSearch(msg.grid);
                break;
            case 'WordBank':
                console.log("WordBank recieved");
                displayWordBank(msg.WordsUsed);
                break;  
            case 'FoundWord':
                console.log("FoundWord recieved");
                crossOutWord(msg.FoundWordIndex)
                break;   
            default:
                console.log("Unkown message")
                break;
        }
     }
    
    //Generates HTML table from JSON data for the word search
    function generateTable(arrayData) {
        var table = '<table border="1" id="WordGrid" >';
            for (var i = 0; i < arrayData.length; i++) {
                table += '<tr onclick="clickFunctionRow(this)">';
                for (var j = 0; j < arrayData[i].length; j++) {
                    //table += '<td>' + arrayData[i][j] + '</td>';
                    table += '<td onclick="clickFunctionCol(this)">' + arrayData[i][j] + '</td>';
                }
                table += '</tr>';
            }
        table += '</table>';
        return table;
    }

    //Generates the list of words for the word bank
    function generateWordBank(arrayData) {
        var table = '<ul id=WordBank>';
            for (var i = 0; i < arrayData.length; i++) {
                table += '<li>' + arrayData[i] + '</li>'
            }
        table += '</ul>';
        return table;
    }

    //Puts the generated table into the container for word search
    function displayWordSearch(arrayData) {
        var container = document.getElementById('table-container');
        container.innerHTML = generateTable(arrayData);
    }

    //Puts the generated list into the container for word bank
    function displayWordBank(arrayData) {
        var container = document.getElementById('answer-container');
        container.innerHTML = generateWordBank(arrayData);
    } 

    var rIndexOne = -1;
    var rIndexTwo = -1;
    var cIndexOne = -1;
    var cIndexTwo = -1;
    

    function clickFunctionCol(x){
        console.log("column = " + x.cellIndex);

        if(cIndexOne == -1){
            cIndexOne = x.cellIndex;
        }else{
            cIndexTwo = x.cellIndex;
        }
    }

    function clickFunctionRow(x){
        console.log("row = " + x.rowIndex);
        var WordGrid = document.getElementById('WordGrid');
        

        if(rIndexOne == -1){
            rIndexOne = x.rowIndex;
            var row = WordGrid.rows[rIndexOne];
            var cell = row.cells[cIndexOne];
            //cell.classList.toggle('selected');
            cell.style.backgroundColor = localStorage.getItem('playerColor');
        }else{
            rIndexTwo = x.rowIndex;
            checkWord();
        }
    }

    function checkWord(){
        console.log("Checking Word at this location: " + cIndexOne, rIndexOne, cIndexTwo, rIndexTwo);
        connection.send("WordCheck" + " (" + cIndexOne + "," + rIndexOne + ")(" + cIndexTwo + "," + rIndexTwo + ") ");
    }

    function crossOutWord(FoundWordIndex){
        var WordGrid = document.getElementById('WordGrid');
        var ColDiff = (cIndexTwo - cIndexOne);
        var RowDiff = (rIndexTwo - rIndexOne);
        var row = WordGrid.rows[rIndexOne];
        var cell = row.cells[cIndexOne];
        
        if(FoundWordIndex != -1){
            //Cross Out Word in wordbank IF found word was correct
            var wordBank = document.getElementById('WordBank');
            wordBank.children[FoundWordIndex].classList.add('crossed-out');
            
            //Create line of highlighted boxes to fill out the whole word
            for(var i = 0; i < Math.max(Math.abs(ColDiff), Math.abs(RowDiff)); i++){
                if(RowDiff < 0){
                    row = WordGrid.rows[rIndexOne -= 1];
                }
                if(RowDiff > 0){
                    row = WordGrid.rows[rIndexOne += 1];
                }
                if(ColDiff < 0)
                {
                    cell = row.cells[cIndexOne -= 1];
                }
                if(ColDiff > 0){
                    cell = row.cells[cIndexOne += 1];
                }
                cell.style.backgroundColor = localStorage.getItem('playerColor');
            }
            
        }else{
            //If FoundWordIndex was -1 that means no correct word was found so selected sqaure goes back 
            //to default color
            cell.style.backgroundColor = "cadetblue";
        }

        //Reset the index variables
        rIndexOne = -1;
        rIndexTwo = -1;
        cIndexOne = -1;
        cIndexTwo = -1;
        
    }

    

    

</script>
