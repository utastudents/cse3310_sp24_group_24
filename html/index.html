<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./css/lobby_styles.css">
        <title>Word Game Lobby</title>
    </head>
<body>
    <div class="landing-page">
        <h1>WORD GAME</h1>
        <img src="https://media.giphy.com/media/3o7aCTXVcHJgJ4yoeI/giphy.gif" alt="Pirate">
        <h3>Type your Name to Enter the Lobby</h3>
        <form id="nameForm">
            <label for="playerName">First Name:</label><br>
            <input type="text" id="playerName" name="playerName" required><br>
            <input type="submit" value="Join">
        </form>
    </div>


    <div class="lobby-page">
        <h1 style="text-align: center;">WORD GAME LOBBY</h1>
        <div class="container">
            <div class="left-column">
                <div class="box">
                    <h1 class="header_text">Nick Handles</h1>
                    <ol id="playerNick" class="player-nick"></ol>
                    <button id="button" onclick="readyqueue()">Join Queue</button>
                </div>
                <div class="box">
                    <h1 class="header_text">Leaderboard</h1>
                    <div class="button-container">
                        <button id="button" onclick="view_leaderboard()">Click to View</button>
                    </div>
                </div>
            </div>
    
            <div class="chatbox-container">
                <div class="chatbox" id="chatbox">
                    <div class="message bot-message">Display Message</div>
                </div>
            </div>
    
            <div class="right-column">
                <div class="box">
                    <h1 class="header_text">Players Ready</h1>
                    <ol id="playerQueue" class="player-nick"></ol> <!-- Corrected ID -->
                </div>
                <div class="box">
                    <h1 class="header_text">Waiting for Host</h1>
                    <button id="startButton" onclick="startGame()"> Begin</button>
                </div>
            </div>
        </div>
        
        <input type="text" id="userInput" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
    </div>
    
    
    <script>
        // Establish WebSocket connection when the page loads
        var serverUrl = 'ws://' + window.location.hostname + ':9124';
        var socket = new WebSocket(serverUrl);
        var playerNames = [];

        socket.onopen = function() {
            console.log('Connected to server');
            let playerNames = sessionStorage.getItem('playerNames');
            playerNames = playerNames ? JSON.parse(playerNames) : [];

            const playerName = sessionStorage.getItem('playerName');
            if (playerName) {
                socket.send(JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
                displayNick(playerName, playerNames);

                // Store the updated list of player names back to sessionStorage
                sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
            }
        };
        

        document.getElementById('nameForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const playerName = document.getElementById("playerName").value; 
            playerNames.push(playerName);
            //sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
            sessionStorage.setItem('playerName', playerName);
            //console.log('Player names:', playerNames);
            socket.send(JSON.stringify({ type: 'newPlayer', playerName: playerName }));
            Lobby_display();
        });


        
        function Lobby_display() {
            const landingPage = document.querySelector(".landing-page");
            const lobbyPage = document.querySelector(".lobby-page");
            landingPage.style.display = "none";
            lobbyPage.style.display = "flex";

            const playerName = sessionStorage.getItem('playerName');
            if (playerName) {
            // Display the player name in the lobby
            displayNick(playerName, playerNames);

        // Send a message to the server indicating that the player has joined the lobby
            socket.send(JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));

        // Store the updated list of player names back to sessionStorage
            sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
    }
}

    
           /* if (lobbyPage.style.display === "none") {
                lobbyPage.style.display = "flex";
                landingPage.style.display = "none"; // Hide the landing page
            }*/
    
    

        const playerName = sessionStorage.getItem('playerName');
            if (playerName) {
                socket.send(JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
                displayNick(playerName, playerNames);

                // Store the updated list of player names back to sessionStorage
                sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
            }
        
    

        socket.onmessage = function(event) {
            console.log('Message from server: ', event.data);
            const message = JSON.parse(event.data);
            
            if (message.sender && message.content) {
                displayMessage(`${message.sender}: ${message.content}`, "user-message");
            }
    
        };

        socket.onclose = function() {
            console.log('WebSocket connection closed');
            displayMessage("Server connection closed", "bot-message");
        };

        socket.onerror = function(error) {
            console.error('WebSocket Error: ', error);
        };

        function sendMessage() {
            const userInput = document.getElementById("userInput");
            const content = userInput.value.trim();
            const playerName = sessionStorage.getItem('playerName') || 'Anonymous';
            if (content) {
                const message = { sender: playerName, content: content };
                socket.send(JSON.stringify(message));
                displayMessage(`${playerName}: ${content}`, "user-message");
                userInput.value = '';
            }
        }

        function displayMessage(message, className) {
            const chatbox = document.getElementById("chatbox");
            const messageElement = document.createElement("div");
            messageElement.textContent = message;
            messageElement.classList.add("message", className);
            chatbox.appendChild(messageElement);
            chatbox.scrollTop = chatbox.scrollHeight; // Keep the chat scrolled to the bottom
        }

        
        function displayNick(playerName, playerNames) {
    // Get the element where player names are displayed
            const playerNick = document.getElementById('playerNick');
    // Create a new list item for the new player's name
            const li = document.createElement('li');
            li.textContent = playerName;
    // Append the new player's name to the list of player names displayed in the lobby
            playerNick.appendChild(li);
    // Add the new player's name to the list of player names
            playerNames.push(playerName);
    // Update the session storage with the updated list of player names
            sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
    
    // Send the updated list of player names to the server
            socket.send(JSON.stringify({ playerNames: playerNames }));
        }


        function updateBeginButtonVisibility() {
            const playerNickItems = document.getElementById("playerNick").getElementsByTagName("li");
            const beginButtonContainer = document.getElementById("beginButtonContainer");
            if (playerNickItems.length === 1) {
                beginButtonContainer.style.display = "block"; // Show Begin button if this is the first player
            } else {
                beginButtonContainer.style.display = "none"; // Hide Begin button for subsequent players
            }
        }

        function startGame() {
            const playerNickItems = document.getElementById("playerNick").getElementsByTagName("li");
            if (playerNickItems.length > 0) {
                const firstPlayer = playerNickItems[0].textContent;
                alert(firstPlayer + " has started the game!");
            } else {
                alert("No players in the lobby yet!");
            }
        }

        function readyqueue() {
            const playerNick = sessionStorage.getItem('playerName');
            if (playerNick) {
                //displayNick(playerNick, playerNames);
                const playerQueue = document.getElementById('playerQueue');
                const li = document.createElement('li');
                li.textContent = playerNick;
                playerQueue.appendChild(li);
                // Send the player nick to the server
                playerNames.push(playerName);
                socket.send(JSON.stringify({ playerNick: playerName }));
            } else {
                console.error('Player name not found.');
            }
        }

        function view_leaderboard() {
            window.location.href = 'Leaderboard.html';
        }

    </script>
</body>
</html>
