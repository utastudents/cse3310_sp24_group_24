<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./css/lobby_styles.css">
        <title>Word Game Lobby</title>
    </head>
<body>
    <div class="landing-page">
        <h1>WORD GAME</h1>
        <img src="https://media.giphy.com/media/3o7aCTXVcHJgJ4yoeI/giphy.gif" alt="Pirate">
        <h3>Enter Name And Color To Enter</h3>
        <form id="nameForm">
            <label for="playerName">First Name:</label><br>
            <input type="text" id="playerName" name="playerName" required><br>

            <label for="playerColor">Your Color:</label><br>
            <input type="color" id="playerColor" name="playerColor" required><br>

            <input type="submit" value="Join">
        </form>
    </div>

    <div class="lobby-page">
        <h1 style="text-align: center;">WORD GAME LOBBY</h1>
        <div class="container">
            <div class="left-column">
                <div class="box">
                    <h1 class="header_text">Nick Handles</h1>
                    <ol id="playerNick" class="player-nick"></ol>
                    <button id="button" onclick="readyqueue()">Join Queue</button>
                </div>
                <div class="box">
                    <h1 class="header_text">Leaderboard</h1>
                    
                    <ol id="leaderboard" style="list-style-type:none;"></ol>

                    <div class="button-container">
                        <button id="button" onclick="">Click to View</button>
                    </div>
                </div>
            </div>
    
            <div class="chatbox-container">
                <div class="chatbox" id="chatbox">
                    <div class="message bot-message">Display Message</div>
                </div>
            </div>
    
            <div class="right-column">
                <div class="box">
                    <h1 class="header_text">Players Ready</h1>
                    <ol id="playerQueue" class="player-nick"></ol> <!-- Corrected ID -->
                </div>
                <div class="box">
                    <h1 class="header_text">Start Game With</h1>
                    <button id="startButton" onclick="startGame()"> Begin</button>
                </div>
            </div>
        </div>
        
        <input type="text" id="userInput" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
    </div>
    
    <div class="game-page">
            <h1 style="text-align: center;"> WORD SEARCH GAME </h1>

            <div id="leftbox">
                <h2> Player 1 Name </h2>
            </div>

            <div id="centerbox">
                <div id="table-container"> 
                    
                </div>
                <h2 style="text-align: center;"> WORD BANK </h2>
                <div class="scroll-box" id="answer-container"> 

                </div>
            </div>
    
            <div id="rightbox">
                <h2> Player 2 Name</h2>
            </div>
       
    </div>
</body>
    <script>
        // Establish WebSocket connection when the page loads
        var serverUrl;
        var socket = null;
        serverUrl = "ws://" + window.location.hostname +":"+ (parseInt(location.port) + 100);
        var socket = new WebSocket(serverUrl);
        var playerNames = [];

        socket.onopen = function() {
            console.log('Connected to server');
            const lobbyPage = document.querySelector(".lobby-page");
            lobbyPage.style.display = "none";
            const gamePage = document.querySelector(".game-page");
            gamePage.style.display = "none";
            /*
            const gamePage = document.querySelector(".game-page");
            gamePage.style.display = "none";
            let storedPlayerNames = localStorage.getItem('playerNames');
            playerNames = storedPlayerNames ? JSON.parse(storedPlayerNames) : [];

            const playerName = localStorage.getItem('playerName');
            if (playerName) {
            socket.send(JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
            console.log("sending " + JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
            displayNick(playerName, playerNames);

            // Store the updated list of player names in localStorage
            localStorage.setItem('playerNames', JSON.stringify(playerNames));
            }
            */
           
        };
        

        document.getElementById('nameForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const playerName = document.getElementById("playerName").value; 
            if (playerName.trim() !== "")
            {
                var allPlayersnames = document.querySelector("#playerNick");
                for (var i = 0; i < allPlayersnames.length; i++)
                {
                    alert("Name already in use. Try again");
                    return;
                }
            }
        
            displayNick(playerName, playerNames);
            Lobby_display();

            //playerNames.push(playerName);
            //sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
            //sessionStorage.setItem('playerName', playerName);
            //console.log('Player names:', playerNames);
            socket.send(JSON.stringify({ Type: 'newPlayer', playerName: playerName,"ConnectionID":ConnectionID }));
            console.log("sending " + JSON.stringify({ Type: 'newPlayer', playerName: playerName,"ConnectionID":ConnectionID }));
            //Lobby_display();


            if (playerName) {
                // Auto 0 to the new player
                const startScore = 0;
                
                // Add the player
                updateLeaderboard(playerName, startScore);
            }
        });
      


        
        function Lobby_display() {
            const landingPage = document.querySelector(".landing-page");
            const lobbyPage = document.querySelector(".lobby-page");
            const gamePage = document.querySelector(".game-page");
            landingPage.style.display = "none";
            lobbyPage.style.display = "block";
            gamePage.style.display = "none";

            //const playerName = ""; //sessionStorage.getItem('playerName');
            if (playerName) {
            // Display the player name in the lobby
            displayNick(playerName, playerNames);

        // Send a message to the server indicating that the player has joined the lobby
            socket.send(JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
            console.log(JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
        // Store the updated list of player names back to sessionStorage
            //sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
    }
}

    
           /* if (lobbyPage.style.display === "none") {
                lobbyPage.style.display = "flex";
                landingPage.style.display = "none"; // Hide the landing page
            }*/
    
    

        const playerName = "";//sessionStorage.getItem('playerName');
            if (playerName) {
                socket.send(JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
                console.log("sending "+JSON.stringify({ sender: playerName, content: 'has joined the lobby' }));
                displayNick(playerName, playerNames);

                // Store the updated list of player names back to sessionStorage
                //sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
            }
        
    
        ConnectionID=-1;

        socket.onmessage = function(event) {
            console.log('Message from server: ' +  event.data);
            const message = JSON.parse(event.data);
           
            switch(message.type){
            case 'Grid':
                console.log("Grid recieved");
                displayWordSearch(message.grid);
                break;
            case 'WordBank':
                console.log("WordBank recieved");
                displayWordBank(message.WordsUsed);
                break;  
            case 'FoundWord':
                console.log("FoundWord recieved");
                crossOutWord(message.FoundWordIndex)
                break;   
            case 'ID':
                ConnectionID = message.ConnectionID;
                console.log("my connection id is " + ConnectionID);
                break;
            case 'sender':
                updatePlayerList(message.players);
                if ('sender' in message) {
                displayMessage(message.sender, message.content);
                }
                break;
            default:
                console.log("Unkown message")
                break;
        }

};
    
        

        socket.onclose = function() {
            console.log('WebSocket connection closed');
            displayMessage("Server connection closed", "bot-message");
        };

        socket.onerror = function(error) {
            console.error('WebSocket Error: ', error);
        };

        function sendMessage() {
            const userInput = document.getElementById("userInput");
            const content = userInput.value.trim();
            const playerName = document.getElementById("playerName").value.trim(); //sessionStorage.getItem('playerName') || 'Anonymous';
            if (content) {
                const message = { sender: playerName, content: content };
                socket.send(JSON.stringify(message));
                console.log("sending "+JSON.stringify(message));
                displayMessage(`${playerName}: ${content}`, "user-message");
                userInput.value = '';
            }
        }

        function displayMessage(message, className) {
            const chatbox = document.getElementById("chatbox");
            const messageElement = document.createElement("div");
            messageElement.textContent = message;
            messageElement.classList.add("message", className);
            chatbox.appendChild(messageElement);
            chatbox.scrollTop = chatbox.scrollHeight; // Keep the chat scrolled to the bottom
        }

        
        function displayNick(playerName, playerNames) {
    // Get the element where player names are displayed
            const playerNick = document.getElementById('playerNick');
    // Create a new list item for the new player's name
            const li = document.createElement('li');
            li.textContent = playerName;
    //font size
            li.style.fontSize = "20px"; 

    // Append the new player's name to the list of player names displayed in the lobby
            playerNick.appendChild(li);
    // Add the new player's name to the list of player names
            playerNames.push(playerName);
    // Update the session storage with the updated list of player names
            //sessionStorage.setItem('playerNames', JSON.stringify(playerNames));
    
    // Send the updated list of player names to the server
            socket.send(JSON.stringify({ playerNames: playerNames }));
        }
        function updatePlayerList(players) {
            const playerNick = document.getElementById('playerNick');
            playerNick.innerHTML = ''; // Clear the existing player list

            // Add each player to the player list in the HTML
             players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player;
                 playerNick.appendChild(li);
                });
            }


        function updateBeginButtonVisibility() {
            const playerNickItems = document.getElementById("playerNick").getElementsByTagName("li");
            const beginButtonContainer = document.getElementById("beginButtonContainer");
            if (playerNickItems.length === 1) {
                beginButtonContainer.style.display = "block"; // Show Begin button if this is the first player
            } else {
                beginButtonContainer.style.display = "none"; // Hide Begin button for subsequent players
            }
        }

        function startGame() {
            const playerNickItems = document.getElementById("playerNick").getElementsByTagName("li");
            

            
            const lobbyPage = document.querySelector(".lobby-page");
            const landingPage = document.querySelector(".landing-page");
            const gamePage = document.querySelector(".game-page");
            lobbyPage.style.display = "none";
            landingPage.style.display = "none";
            gamePage.style.display = "block";
            
            

            
            if (playerNickItems.length > 0) {
                const firstPlayer = playerNickItems[0].textContent;
                alert(firstPlayer + " has started the game!");
            } else {
                alert("No players in the lobby yet!");
            }
        }
        /*
        function readyqueue() {
            const playerNick = "";//sessionStorage.getItem('playerName');
            if (playerNick) {
                //displayNick(playerNick, playerNames);
                const playerQueue = document.getElementById('playerQueue');
                const li = document.createElement('li');
                li.textContent = playerNick;
                playerQueue.appendChild(li);
                // Send the player nick to the server
                playerNames.push(playerName);
                socket.send(JSON.stringify({ playerNick: playerName }));
            } else {
                console.error('Player name not found.');
            }
        }
        */
        function readyqueue() {
            var playerDoesExist = 0;
            const playerName = document.getElementById("playerName").value.trim(); // Get the player's name from the input field
            for(i = 0; i <= playerNames.length; i++) {
                if ((playerName!=playerNames[i]) && (i == playerNames.length)) {
                    const playerQueue = document.getElementById('playerQueue');
                    const li = document.createElement('li');
                    li.textContent = playerName; // Use the player's name obtained from the input field
                    li.style.fontSize = "20px"; 
                    playerQueue.appendChild(li);
                    playerDoesExist = 1;
                    break;
                } else if (playerName==playerNames[i]) {
                    console.error('Player name already in the ready queue.');
                    playerDoesExist = 1;
                    break;
                }
            }

            if (!playerDoesExist){
                /* Player exists and is in queue. */
            } else {
                console.error('Player name not found.');
            }

            
        }



        let leaderboardData = [];
        function updateLeaderboard(playerName, score) {
            // Check player is in leaderboard
            const existPlayer = leaderboardData.findIndex(player => player.name === playerName);
            
            if (existPlayer !== -1) {
                // Update score if they are already in  leaderboard
                leaderboardData[existingPlayer].score = score;
            } else {
                // Add a new player
                leaderboardData.push({ name: playerName, score: score });
            }
            
            // Sort by score
            leaderboardData.sort((a, b) => b.score - a.score);
            
            //update leaderboard
            view_leaderboard();
        }

        function view_leaderboard() {
            // window.location.href = 'Leaderboard.html';
            // causes the page to be loaded
            const leaderboardElement = document.getElementById('leaderboard');
    
            // Clear leaderboard content
            leaderboardElement.innerHTML = '';
            
            // Loop through the leaderboard per player
            leaderboardData.forEach((player, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${player.name}: ${player.score}`;
                leaderboardElement.appendChild(li);
            });
        }

        function generateTable(arrayData) {
        var table = '<table border="1" id="WordGrid" >';
            for (var i = 0; i < arrayData.length; i++) {
                table += '<tr onclick="clickFunctionRow(this)">';
                for (var j = 0; j < arrayData[i].length; j++) {
                    //table += '<td>' + arrayData[i][j] + '</td>';
                    table += '<td onclick="clickFunctionCol(this)">' + arrayData[i][j] + '</td>';
                }
                table += '</tr>';
            }
        table += '</table>';
        return table;
    }

    //Generates the list of words for the word bank
    function generateWordBank(arrayData) {
        var table = '<ul id=WordBank>';
            for (var i = 0; i < arrayData.length; i++) {
                table += '<li>' + arrayData[i] + '</li>'
            }
        table += '</ul>';
        return table;
    }

    //Puts the generated table into the container for word search
    function displayWordSearch(arrayData) {
        var container = document.getElementById('table-container');
        container.innerHTML = generateTable(arrayData);
    }

    //Puts the generated list into the container for word bank
    function displayWordBank(arrayData) {
        var container = document.getElementById('answer-container');
        container.innerHTML = generateWordBank(arrayData);
    } 

    var rIndexOne = -1;
    var rIndexTwo = -1;
    var cIndexOne = -1;
    var cIndexTwo = -1;
    

    function clickFunctionCol(x){
        console.log("column = " + x.cellIndex);

        if(cIndexOne == -1){
            cIndexOne = x.cellIndex;
        }else{
            cIndexTwo = x.cellIndex;
        }
    }

    function clickFunctionRow(x){
        console.log("row = " + x.rowIndex);
        var WordGrid = document.getElementById('WordGrid');
        

        if(rIndexOne == -1){
            rIndexOne = x.rowIndex;
            var row = WordGrid.rows[rIndexOne];
            var cell = row.cells[cIndexOne];
            //cell.classList.toggle('selected');
            cell.style.backgroundColor = localStorage.getItem('playerColor');
        }else{
            rIndexTwo = x.rowIndex;
            checkWord();
        }
    }

    function checkWord(){
        console.log("Checking Word at this location: " + cIndexOne, rIndexOne, cIndexTwo, rIndexTwo);
        socket.send("WordCheck" + " (" + cIndexOne + "," + rIndexOne + ")(" + cIndexTwo + "," + rIndexTwo + ") ");
    }

    function crossOutWord(FoundWordIndex){
        var WordGrid = document.getElementById('WordGrid');
        var ColDiff = (cIndexTwo - cIndexOne);
        var RowDiff = (rIndexTwo - rIndexOne);
        var row = WordGrid.rows[rIndexOne];
        var cell = row.cells[cIndexOne];
        
        if(FoundWordIndex != -1){
            //Cross Out Word in wordbank IF found word was correct
            var wordBank = document.getElementById('WordBank');
            wordBank.children[FoundWordIndex].classList.add('crossed-out');
            
            //Create line of highlighted boxes to fill out the whole word
            for(var i = 0; i < Math.max(Math.abs(ColDiff), Math.abs(RowDiff)); i++){
                if(RowDiff < 0){
                    row = WordGrid.rows[rIndexOne -= 1];
                }
                if(RowDiff > 0){
                    row = WordGrid.rows[rIndexOne += 1];
                }
                if(ColDiff < 0)
                {
                    cell = row.cells[cIndexOne -= 1];
                }
                if(ColDiff > 0){
                    cell = row.cells[cIndexOne += 1];
                }
                cell.style.backgroundColor = localStorage.getItem('playerColor');
            }
            
        }else{
            //If FoundWordIndex was -1 that means no correct word was found so selected sqaure goes back 
            //to default color
            cell.style.backgroundColor = "cadetblue";
        }

        //Reset the index variables
        rIndexOne = -1;
        rIndexTwo = -1;
        cIndexOne = -1;
        cIndexTwo = -1;
        
    }

    

        function generateTable(arrayData) {
        var table = '<table border="1" id="WordGrid" >';
            for (var i = 0; i < arrayData.length; i++) {
                table += '<tr onclick="clickFunctionRow(this)">';
                for (var j = 0; j < arrayData[i].length; j++) {
                    //table += '<td>' + arrayData[i][j] + '</td>';
                    table += '<td onclick="clickFunctionCol(this)">' + arrayData[i][j] + '</td>';
                }
                table += '</tr>';
            }
        table += '</table>';
        return table;
    }

    //Generates the list of words for the word bank
    function generateWordBank(arrayData) {
        var table = '<ul id=WordBank>';
            for (var i = 0; i < arrayData.length; i++) {
                table += '<li>' + arrayData[i] + '</li>'
            }
        table += '</ul>';
        return table;
    }

    //Puts the generated table into the container for word search
    function displayWordSearch(arrayData) {
        var container = document.getElementById('table-container');
        container.innerHTML = generateTable(arrayData);
    }

    //Puts the generated list into the container for word bank
    function displayWordBank(arrayData) {
        var container = document.getElementById('answer-container');
        container.innerHTML = generateWordBank(arrayData);
    } 

    var rIndexOne = -1;
    var rIndexTwo = -1;
    var cIndexOne = -1;
    var cIndexTwo = -1;
    

    function clickFunctionCol(x){
        console.log("column = " + x.cellIndex);

        if(cIndexOne == -1){
            cIndexOne = x.cellIndex;
        }else{
            cIndexTwo = x.cellIndex;
        }
    }

    function clickFunctionRow(x){
        console.log("row = " + x.rowIndex);
        var WordGrid = document.getElementById('WordGrid');
        

        if(rIndexOne == -1){
            rIndexOne = x.rowIndex;
            var row = WordGrid.rows[rIndexOne];
            var cell = row.cells[cIndexOne];
            //cell.classList.toggle('selected');
            cell.style.backgroundColor = localStorage.getItem('playerColor');
        }else{
            rIndexTwo = x.rowIndex;
            checkWord();
        }
    }

    function checkWord(){
        console.log("Checking Word at this location: " + cIndexOne, rIndexOne, cIndexTwo, rIndexTwo);
        socket.send("WordCheck" + " (" + cIndexOne + "," + rIndexOne + ")(" + cIndexTwo + "," + rIndexTwo + ") ");
    }

    function crossOutWord(FoundWordIndex){
        var WordGrid = document.getElementById('WordGrid');
        var ColDiff = (cIndexTwo - cIndexOne);
        var RowDiff = (rIndexTwo - rIndexOne);
        var row = WordGrid.rows[rIndexOne];
        var cell = row.cells[cIndexOne];
        
        if(FoundWordIndex != -1){
            //Cross Out Word in wordbank IF found word was correct
            var wordBank = document.getElementById('WordBank');
            wordBank.children[FoundWordIndex].classList.add('crossed-out');
            
            //Create line of highlighted boxes to fill out the whole word
            for(var i = 0; i < Math.max(Math.abs(ColDiff), Math.abs(RowDiff)); i++){
                if(RowDiff < 0){
                    row = WordGrid.rows[rIndexOne -= 1];
                }
                if(RowDiff > 0){
                    row = WordGrid.rows[rIndexOne += 1];
                }
                if(ColDiff < 0)
                {
                    cell = row.cells[cIndexOne -= 1];
                }
                if(ColDiff > 0){
                    cell = row.cells[cIndexOne += 1];
                }
                cell.style.backgroundColor = localStorage.getItem('playerColor');
            }
            
        }else{
            //If FoundWordIndex was -1 that means no correct word was found so selected sqaure goes back 
            //to default color
            cell.style.backgroundColor = "cadetblue";
        }

        //Reset the index variables
        rIndexOne = -1;
        rIndexTwo = -1;
        cIndexOne = -1;
        cIndexTwo = -1;
        
    }

    

    </script>
</html>
